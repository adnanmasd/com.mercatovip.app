<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>MercatoVIP Mobile APP</title>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="static/css/framework7.ios.min.css" rel="stylesheet">
    <script type="text/javascript">
        if (localStorage.getItem('language_id') == 2) {
            document.write("<link href='static/css/framework7.ios.rtl.min.css' rel='stylesheet'>");
        }
    </script>
    <link href="static/css/framework7.ios.colors.min.css" rel="stylesheet">
    <!-- built style files will be auto injected -->
</head>

<body class="font-dubai-regular">
    <div id="token_id"></div>
    <div id="app"></div>
    <!-- built script files will be auto injected -->
    <script>
        function handleOpenURL(url) {
          console.log("received url: " + url);
        }

        document.addEventListener('deviceready', function(evt) {
            window.backButton = 0;
            window.open = cordova.InAppBrowser.open;
            var networkState = navigator.connection.type;
            if (networkState == "Connection.NONE") {
                localStorage.setItem("connection", "false");
            } else {
                localStorage.setItem("connection", "true");

                var token_id = document.getElementById("token_id");
                window.FirebasePlugin.hasPermission(function(data){
                  if(data.isEnabled){
                  window.FirebasePlugin.onTokenRefresh(function(token) {
                    // save this server-side and use it to push notifications to this device
                      console.log(token);
                      token_id.innerHTML = token;
                  }, function(error) {
                      console.error(error);
                  });} else {
                    window.FirebasePlugin.grantPermission();
                  }
                });

                if (localStorage.getItem("push") !== true) {
                    window.FirebasePlugin.subscribe("marketing");
                    localStorage.setItem("push", true)
                }

                window.FirebasePlugin.onNotificationOpen(function(notification) {
                    console.log(notification);
                    if (notification.tap == true) {
                      if (notification.path == true) {
                          window.f7.mainView.router.loadPage(notification.path)
                      }
                    } else {
                      window.f7.addNotification({
                        title: 'MercatoVIP',
                        message: notification.aps.alert,
                        onClick: function() {
                          if (notification.path == true) {
                              window.f7.mainView.router.loadPage(notification.path)
                          }
                        }
                      });
                    }
                }, function(error) {
                    console.error(error);
                });
            }
            universalLinks.subscribe('openurl', function(eventData) {
              console.log('Did launch app from the link: ' + eventData.url);
              console.log(eventData);
              let url = eventData.url.split("/")
              let $$ = window.Dom7;
              $$.ajax({
                method : 'GET',
                dataType : 'json',
                headers : {
                  "X-Oc-Merchant-Id" :	"4RsyLcNY41FH1WGWWlxCLow8GVFrWZIR",
                  "X-Oc-Merchant-Language" : localStorage.getItem('language_code'),
                  "X-Oc-Session" : localStorage.getItem('session_id') ? localStorage.getItem('session_id') : '',
                  "Content-Type" : "application/json",
                  "Accept" : "application/json",
                },
                url : "https://mercatovip.com/api/rest/seourl/" + url[url.length - 1],
                success : function (e,status,xhr){
                  let tg = e.data.query.split('=');
                  let path = "";
                  switch (tg[0]) {
                    case 'product_id' :
                        path = "/product?product_id="+tg[1]
                        break;
                    case 'category_id' :
                        path = "/category?category_id="+tg[1]
                        break;
                    case 'manufacturer_id' :
                        path = "/manufacturer?manufacturer_id="+tg[1]
                        break;
                    case 'information_id' :
                        path = "/information?information_id="+tg[1]
                        break;
                    default:
                        path = null
                  }
                  if (path !== null)
                  window.f7.mainView.router.loadPage(path)
                },
                error : function(e,staus,xhr){
                  console.log(e);
                }
              });
            });
            universalLinks.subscribe('payconfirm', function(eventData) {
              console.log('Did launch app from the link: ' + eventData.url);
              console.log(eventData);
              window.f7.mainView.router.reloadPage("/thankyou");
            });
            universalLinks.subscribe('payfail', function(eventData) {
              console.log('Did launch app from the link: ' + eventData.url);
              console.log(eventData);
              alert('fail');
            });
        }, false);

        document.addEventListener("offline", function onOffline() {
            localStorage.setItem("connection", "false");
            window.f7.alert("No Internet Connection!", "Warning", function() {
                location.reload();
            });
        }, false);

        document.addEventListener("online", function onOnline() {
            if (localStorage.getItem("connection") == "false") {
                localStorage.setItem("connection", "true");
                location.reload();
            }
        }, false);
    </script>
</body>
</html>
